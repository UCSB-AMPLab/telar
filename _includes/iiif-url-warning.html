{%- comment -%}
IIIF URL Mismatch Warning
Detects when viewing site URL doesn't match IIIF manifest URLs and provides helpful guidance
{%- endcomment -%}

<div id="iiif-url-warning" class="alert alert-warning telar-alert" role="alert" style="display: none;">
  <strong>{{ lang.errors.iiif_mismatch.heading }}</strong>
  <p>{{ lang.errors.iiif_mismatch.description }}</p>

  <p class="mb-2"><strong>{{ lang.errors.iiif_mismatch.whats_happening }}</strong></p>
  <ul class="mb-3">
    <li>{{ lang.errors.iiif_mismatch.viewing_at }} <strong id="current-url"></strong></li>
    <li>{{ lang.errors.iiif_mismatch.configured_for }} <strong id="manifest-url"></strong></li>
  </ul>

  <p class="mb-2"><strong id="affected-images-heading">{{ lang.errors.iiif_mismatch.affected_images }}</strong></p>
  <ul class="mb-3" id="affected-images">
    <!-- JavaScript will populate this list -->
  </ul>

  <!-- Production scenario (90% of users) -->
  <div id="production-fix-instructions" style="display: none;">
    <p class="mb-2"><strong>{{ lang.errors.iiif_mismatch.common_causes }}</strong></p>
    <ul class="mb-3">
      <li>{{ lang.errors.iiif_mismatch.cause_incorrect_settings }}</li>
      <li>{{ lang.errors.iiif_mismatch.cause_moved_url }}</li>
      <li>{{ lang.errors.iiif_mismatch.cause_preview_env }}</li>
    </ul>

    <p class="mb-2"><strong>{{ lang.errors.iiif_mismatch.fix_heading }}</strong></p>
    <ol class="mb-3">
      <li>{{ lang.errors.iiif_mismatch.fix_check_config }}
        <ul>
          <li>{{ lang.errors.iiif_mismatch.fix_your_site_at }} <strong id="production-current-url"></strong></li>
          <li>{{ lang.errors.iiif_mismatch.fix_config_should_be }} <code id="production-config-suggestion"></code></li>
        </ul>
      </li>
      <li>{{ lang.errors.iiif_mismatch.fix_commit_push }}</li>
      <li>{{ lang.errors.iiif_mismatch.fix_auto_regenerate }}</li>
    </ol>

    <p class="mb-2"><small>{{ lang.errors.iiif_mismatch.fix_local_option }}</small></p>
    <pre class="bg-light p-2 rounded"><code id="production-local-command"></code></pre>
  </div>

  <!-- Local development scenario (10% of users) -->
  <div id="local-fix-instructions" style="display: none;">
    <p class="mb-2"><strong>{{ lang.errors.iiif_mismatch.common_causes }}</strong></p>
    <ul class="mb-3">
      <li>{{ lang.errors.iiif_mismatch.local_cause_1 }}</li>
      <li>{{ lang.errors.iiif_mismatch.local_cause_2 }}</li>
    </ul>

    <p class="mb-2"><strong>{{ lang.errors.iiif_mismatch.local_fix_heading }}</strong></p>
    <pre class="bg-light p-2 rounded mb-3"><code id="local-command"></code></pre>

    <p class="mb-2"><strong>{{ lang.errors.iiif_mismatch.local_alternative }}</strong></p>
    <ol class="mb-0">
      <li>{{ lang.errors.iiif_mismatch.fix_check_config }}</li>
      <li>Run: <code>python3 scripts/generate_iiif.py</code> {{ lang.errors.iiif_mismatch.local_regenerate_note }}</li>
    </ol>
  </div>
</div>

<script>
// Expose language strings to JavaScript
window.telarLang = {
  affectedImagesCountSingular: "{{ lang.errors.iiif_mismatch.affected_images_count_singular }}",
  affectedImagesCountPlural: "{{ lang.errors.iiif_mismatch.affected_images_count_plural }}"
};
</script>

<script>
(function() {
  // Check for IIIF URL mismatch
  async function checkIIIFUrlMismatch() {
    // Get current site URL
    const currentOrigin = window.location.origin;
    const currentPath = window.location.pathname;

    // Extract baseurl (everything up to the last path segment)
    const pathParts = currentPath.split('/').filter(p => p);
    const baseurl = pathParts.length > 0 ? '/' + pathParts[0] : '';
    const currentSiteUrl = currentOrigin + baseurl;

    // Detect if this is local development or production
    const isLocalDev = currentOrigin.includes('localhost') || currentOrigin.includes('127.0.0.1');

    try {
      // Fetch all objects to check for mismatches
      const objectsResponse = await fetch('{{ "/objects.json" | relative_url }}');
      if (!objectsResponse.ok) return;

      const objects = await objectsResponse.json();

      // Find all objects with local IIIF tiles (no external iiif_manifest)
      const localObjects = objects.filter(obj => {
        return (!obj.iiif_manifest || obj.iiif_manifest === '');
      });

      if (localObjects.length === 0) return; // No local objects to check

      // Check all local objects for URL mismatch
      const affectedObjects = [];
      let manifestBaseUrl = null;

      for (const obj of localObjects) {
        try {
          const manifestPath = `{{ "/iiif/objects" | relative_url }}/${obj.object_id}/manifest.json`;
          const manifestResponse = await fetch(manifestPath);
          if (!manifestResponse.ok) continue; // Skip if manifest doesn't exist

          const manifest = await manifestResponse.json();

          // Extract base URL from manifest ID
          const manifestId = manifest.id;
          const extractedBaseUrl = manifestId.split('/iiif/')[0];

          // Store the manifest base URL (should be same for all)
          if (!manifestBaseUrl) {
            manifestBaseUrl = extractedBaseUrl;
          }

          // Compare URLs (normalize trailing slashes and localhost/127.0.0.1)
          const normalizedCurrent = currentSiteUrl.replace(/\/$/, '').replace('localhost', '127.0.0.1');
          const normalizedManifest = extractedBaseUrl.replace(/\/$/, '').replace('localhost', '127.0.0.1');

          if (normalizedCurrent !== normalizedManifest) {
            affectedObjects.push({
              id: obj.object_id,
              title: obj.title || obj.object_id
            });
          }
        } catch (error) {
          console.log(`Could not check manifest for ${obj.object_id}:`, error);
        }
      }

      // If there are affected objects, show the warning
      if (affectedObjects.length > 0 && manifestBaseUrl) {
        // Populate common elements
        document.getElementById('current-url').textContent = currentSiteUrl;
        document.getElementById('manifest-url').textContent = manifestBaseUrl;

        // Update affected images heading with count
        const heading = document.getElementById('affected-images-heading');
        if (affectedObjects.length === 1) {
          heading.textContent = window.telarLang.affectedImagesCountSingular;
        } else {
          heading.textContent = window.telarLang.affectedImagesCountPlural.replace('__COUNT__', affectedObjects.length);
        }

        // Populate affected images list
        const affectedList = document.getElementById('affected-images');
        affectedList.innerHTML = affectedObjects.map(obj =>
          `<li><strong>${obj.title}</strong> (${obj.id})</li>`
        ).join('');

        // Show context-appropriate fix instructions
        if (isLocalDev) {
          // Local development scenario
          document.getElementById('local-fix-instructions').style.display = 'block';
          document.getElementById('local-command').textContent =
            `python3 scripts/generate_iiif.py --base-url ${currentSiteUrl}`;
        } else {
          // Production scenario
          document.getElementById('production-fix-instructions').style.display = 'block';

          // Parse current URL into url and baseurl components
          const urlObj = new URL(currentSiteUrl);
          const urlPart = `${urlObj.protocol}//${urlObj.host}`;
          const baseurlPart = urlObj.pathname || '';

          document.getElementById('production-current-url').textContent = currentSiteUrl;
          document.getElementById('production-config-suggestion').textContent =
            `url: "${urlPart}" and baseurl: "${baseurlPart}"`;
          document.getElementById('production-local-command').textContent =
            `python3 scripts/generate_iiif.py --base-url ${currentSiteUrl}`;
        }

        // Show the warning
        document.getElementById('iiif-url-warning').style.display = 'block';
      }
    } catch (error) {
      // Silently fail - don't show warning if we can't determine mismatch
      console.log('Could not check IIIF URL mismatch:', error);
    }
  }

  // Run check when page loads
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', checkIIIFUrlMismatch);
  } else {
    checkIIIFUrlMismatch();
  }
})();
</script>
